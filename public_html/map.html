<!DOCTYPE html>
<html lang="en">
	<head>
		<!-- Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ¼ĞµÑ‚Ğ°Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¸ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ CSS -->
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>{{translate "title"}}</title>

		<!-- ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ CSS Leaflet -->
		<link rel="stylesheet" href="/static/leaflet.css">
    <link rel="stylesheet" href="/static/nouislider.min.css">


		<style>
        /* ĞĞ±Ñ‰Ğ¸Ğµ ÑÑ‚Ğ¸Ğ»Ğ¸ */
        body, html {
	        margin: 0;
	        padding: 0;
	        height: 100%;
	        overflow: hidden; /* Ğ£Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ğ¿Ğ¾Ğ»Ğ¾ÑÑ‹ Ğ¿Ñ€Ğ¾ĞºÑ€ÑƒÑ‚ĞºĞ¸ */
        }

				/* ĞšĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€ ĞºĞ°Ñ€Ñ‚Ñ‹ */
				#map {
					height: 100vh; /* Ğ’Ñ‹ÑĞ¾Ñ‚Ğ° ĞºĞ°Ñ€Ñ‚Ñ‹ Ğ½Ğ° Ğ²ĞµÑÑŒ ÑĞºÑ€Ğ°Ğ½ */
					margin: 0;
					overflow: hidden;
				}

				/* Ğ¡Ñ‚Ğ¸Ğ»Ğ¸ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒÑĞºĞ¾Ğ¹ Ğ¿Ğ¾Ğ´ÑĞºĞ°Ğ·ĞºĞ¸ (tooltip) */
				.custom-tooltip {
					background-color: white;
					border-radius: 5px;
					padding: 10px;
					color: #333;
					box-shadow: 0px 0px 3px rgba(0,0,0,0.3);
				}

				/* ĞšĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€ Ğ´Ğ»Ñ ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ² */
				.upload-btn-container {
					position: absolute;
					top: 20px;
					right: 20px;
					z-index: 1000;
				}

				/* Ğ¡Ñ‚Ğ¸Ğ»Ğ¸ Ğ´Ğ»Ñ ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ² */
				.upload-btn {
					background-color: white;
					border: 1px solid #ccc;
					border-radius: 4px;
					padding: 5px 10px;
					cursor: pointer;
					font-size: 14px;
					box-shadow: 0 1px 5px rgba(0,0,0,0.65);
				}

				/* ĞĞ²ĞµÑ€Ğ»ĞµĞ¹ Ğ´Ğ»Ñ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ² */
				#fileOverlay {
					position: fixed;
					top: 0;
					left: 0;
					width: 100%;
					height: 100%;
					background-color: rgba(0, 0, 0, 0.7);
					z-index: 10000;
					display: flex;
					justify-content: center;
					align-items: center;
				}

				/* ĞšĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€ Ğ¿Ñ€Ğ¾Ğ³Ñ€ĞµÑÑĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ² */
				#fileProgressContainer {
					background-color: white;
					padding: 20px;
					border-radius: 10px;
					max-width: 600px;
					width: 100%;
					box-shadow: 0 0 15px rgba(0, 0, 0, 0.3);
				}

				/* Ğ˜Ğ½Ğ´Ğ¸Ğ²Ğ¸Ğ´ÑƒĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¿Ñ€Ğ¾Ğ³Ñ€ĞµÑÑ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ Ñ„Ğ°Ğ¹Ğ»Ğ° */
				.file-progress {
					margin-bottom: 15px;
				}

				.file-name {
					font-weight: bold;
					margin-bottom: 5px;
				}

				/* ĞŸÑ€Ğ¾Ğ³Ñ€ĞµÑÑ-Ğ±Ğ°Ñ€ */
				.progress-bar {
					width: 100%;
					height: 10px;
					background-color: #f4f4f4;
					border-radius: 5px;
					overflow: hidden;
				}

				.progress-bar-inner {
					height: 100%;
					background-color: #4caf50;
					width: 0%;
				}

				/* Ğ˜Ğ½Ğ´Ğ¸ĞºĞ°Ñ‚Ğ¾Ñ€ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸ Ğ½Ğ° ÑĞµÑ€Ğ²ĞµÑ€Ğµ */
				.server-processing {
					margin-left: 10px;
					font-size: 14px;
					color: #ff9800;
				}

				/* Ğ­Ñ„Ñ„ĞµĞºÑ‚ Ğ½Ğ°Ğ²ĞµĞ´ĞµĞ½Ğ¸Ñ Ğ´Ğ»Ñ ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ */
				.upload-btn:hover {
					background-color: #f4f4f4;
				}

				/* ĞšĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€ Ğ´Ğ»Ñ ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ Ğ³ĞµĞ¾Ğ»Ğ¾ĞºĞ°Ñ†Ğ¸Ğ¸ */
				.locate-btn-container {
					position: absolute;
					top: 60px;
					right: 20px;
					z-index: 1000;
				}

				/* Ğ¡Ñ‚Ğ¸Ğ»Ğ¸ Ğ´Ğ»Ñ ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ Ğ³ĞµĞ¾Ğ»Ğ¾ĞºĞ°Ñ†Ğ¸Ğ¸ */
				.locate-btn {
					background-color: white;
					border: 1px solid #ccc;
					border-radius: 4px;
					padding: 5px 10px;
					cursor: pointer;
					font-size: 16px;
					box-shadow: 0 1px 5px rgba(0, 0, 0, 0.65);
					display: flex;
					align-items: center;
					justify-content: center;
				}

				/* Ğ­Ñ„Ñ„ĞµĞºÑ‚ Ğ½Ğ°Ğ²ĞµĞ´ĞµĞ½Ğ¸Ñ Ğ´Ğ»Ñ ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ Ğ³ĞµĞ¾Ğ»Ğ¾ĞºĞ°Ñ†Ğ¸Ğ¸ */
				.locate-btn:hover {
					background-color: #f4f4f4;
				}

				/* Ğ¡Ñ‚Ğ¸Ğ»Ğ¸ Ğ´Ğ»Ñ ÑÑÑ‹Ğ»ĞºĞ¸ Ğ½Ğ° GitHub */
				.github-link {
					position: absolute;
					bottom: 20px;
					left: 20px;
					z-index: 1000;
				}

				.github-icon {
					width: 40px;
					height: 40px;
					opacity: 0.6;
				}

				.github-icon:hover {
					opacity: 1;
				}

				/* Ğ˜Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğµ */
				.program-info {
					position: absolute;
					bottom: 20px;
					left: 70px;
					z-index: 1000;
					color: #333;
					font-size: 14px;
					opacity: 0.6;
				}

				.program-info a {
					color: #007bff;
					text-decoration: none;
				}

				.program-info a:hover {
					text-decoration: underline;
				}

				.program-info:hover {
					opacity: 1;
				}

				/* ĞšĞ½Ğ¾Ğ¿ĞºĞ° "Ğ’ĞµÑ€Ğ½ÑƒÑ‚ÑŒÑÑ ĞºĞ¾ Ğ²ÑĞµĞ¼ Ñ‚Ñ€ĞµĞºĞ°Ğ¼" */
				.back-to-all-container {
					position: absolute;
					top: 120px;
					right: 20px;
					z-index: 1000;
					display: none;
				}

				.back-to-all-btn {
					background-color: white;
					border: 1px solid #ccc;
					border-radius: 4px;
					padding: 5px 10px;
					cursor: pointer;
					font-size: 14px;
					box-shadow: 0 1px 5px rgba(0,0,0,0.65);
				}

				.back-to-all-btn:hover {
					background-color: #f4f4f4;
				}


				/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â€“â€“ Slider clean-look patch â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
				.date-slider-box {
					padding: 6px;
					width: 50px;
				}

				/* 0) Ğ±Ğ°Ğ·Ğ¾Ğ²Ğ°Ñ Ğ³ĞµĞ¾Ğ¼ĞµÑ‚Ñ€Ğ¸Ñ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ°: Ğ±ÑƒÑ„ĞµÑ€ = 8 px
					 (Ñ€Ğ°Ğ·Ğ¼ĞµÑ€ Ñ€ÑƒÑ‡ĞºĞ¸ / 2)  => Ñ€ÑƒÑ‡ĞºĞ° Ğ¿Ñ€Ğ¸ ĞºÑ€Ğ°Ğ¹Ğ½Ğ¸Ñ… Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸ÑÑ…
				ĞĞ• Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ¸Ñ‚ Ğ·Ğ° Ğ¿Ñ€ĞµĞ´ĞµĞ»Ñ‹ Ğ¾ÑĞ¸                       */
				#dateSlider{
					width:6px;                 /* Ñ‚Ğ¾Ğ»Ñ‰Ğ¸Ğ½Ğ° Ğ¾ÑĞ¸             */
					height:130px;              /* Ñ„Ğ°ĞºÑ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ´Ğ»Ğ¸Ğ½Ğ° Ñ‚Ñ€ĞµĞºĞ° */
					padding:0px 0;             /* â†‘ Ğ²Ğ½ÑƒÑ‚Ñ€. Ğ¾Ñ‚ÑÑ‚ÑƒĞ¿ ÑĞ²ĞµÑ€Ñ…Ñƒ/ÑĞ½Ğ¸Ğ·Ñƒ */
					box-sizing:content-box;    /* Ğ²Ğ°Ğ¶ĞµĞ½ Ğ´Ğ»Ñ padding-Ğ²Ğ½ÑƒÑ‚Ñ€Ğ¸ */
 					margin:16px auto 26px;
				}

				/* 1) ÑĞ°Ğ¼Ğ° Ğ¾ÑÑŒ (ÑĞµÑ€Ğ°Ñ)  */
				#dateSlider .noUi-base{
					background:#bfbfbf;
					width:100%;                /* 6 px ÑˆĞ¸Ñ€Ğ¸Ğ½Ğ°               */
					height:100%;               /* 130 px â€“ 2 Ã— 8 px padding */
				}

				/* 2) Ñ†Ğ²ĞµÑ‚Ğ½Ğ°Ñ Ñ‡Ğ°ÑÑ‚ÑŒ Ğ¢ĞĞ›Ğ¬ĞšĞ Ğ¼ĞµĞ¶Ğ´Ñƒ Ñ€ÑƒÑ‡ĞºĞ°Ğ¼Ğ¸ */
				#dateSlider .noUi-connect{
					background:#1e88e5;        /* Ğ²Ğ°Ñˆ Ñ„Ğ¸Ñ€Ğ¼ĞµĞ½Ğ½Ñ‹Ğ¹/Ğ»ÑĞ±Ğ¾Ğ¹ Ñ†Ğ²ĞµÑ‚ */
				}

				.noUi-vertical .noUi-handle{
					width:32px;
					height:20px;
					left:-18px;              /* Ñ†ĞµĞ½Ñ‚Ñ€Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¿Ğ¾ 6-px Ğ¾ÑĞ¸ */
					border-radius:3px;
					background:#f6f6f6;      /* ÑĞ²ĞµÑ‚Ğ»Ğ°Ñ Ñ€ÑƒÑ‡ĞºĞ° */
					border:1px solid #ccc;   /* ÑĞµÑ€Ğ°Ñ Ğ¾Ğ±Ğ²Ğ¾Ğ´ĞºĞ° */
					box-shadow:0 1px 3px rgba(0,0,0,.25);
					cursor:grab;
				}
				/* 4) ÑƒĞ±Ğ¸Ñ€Ğ°ĞµĞ¼ Â«ÑƒÑĞ¸ĞºĞ¸Â»-Ğ¿ÑĞµĞ²Ğ´Ğ¾ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚Ñ‹ */
				.noUi-handle:before,
				.noUi-handle:after{ display:none; }

				.slider-label{
					margin:2px 0;
					font-size:11px;
					line-height:1.15em;
					white-space:nowrap;
					text-align:center; 
				}

				/* â”€â”€â”€â”€â”€ Ğ¿ĞµÑ€ĞµĞºĞ»ÑÑ‡Ğ°Ñ‚ĞµĞ»ÑŒ â€œĞ“Ğ¾Ğ´ / ĞœĞµÑÑÑ†â€ â”€â”€â”€â”€â”€ */
				.slider-toggle{
					display:flex; gap:2px; margin:2px 0 4px;
					font-size:11px; line-height:1; user-select:none;
				}
				.slider-toggle button{
					flex:1 1 0; padding:2px 4px;
					border:1px solid #bbb; background:#f5f5f5;
					border-radius:3px; cursor:pointer;
				}
				.slider-toggle button.active{
					background:#1e88e5; color:#fff; border-color:#1e88e5;
        }

        /* â”€â”€â”€ Year-mode: Ğ´ĞµĞ»Ğ°ĞµĞ¼ Ğ¿Ğ¾Ğ»Ğ·ÑƒĞ½Ğ¾Ğº Ñ‚Ğ°ĞºĞ¾Ğ³Ğ¾ Ğ¶Ğµ Ñ€Ğ¾ÑÑ‚Ğ°, ĞºĞ°Ğº Ğ¼ĞµÑÑÑ‡Ğ½Ñ‹Ğ¹ â”€â”€â”€ */
        #yearSlider{
          /* ĞºĞ¾Ğ¿Ğ¸Ñ Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ğ¾Ğ² Ğ¸Ğ· #dateSlider */
          width:6px;                 /* Ñ‚Ğ¾Ğ»Ñ‰Ğ¸Ğ½Ğ° Ğ¾ÑĞ¸            */
          height:130px;              /* Ğ´Ğ»Ğ¸Ğ½Ğ° Ñ‚Ñ€ĞµĞºĞ°            */
          padding:0;                 /* Ğ²Ğ½ÑƒÑ‚Ñ€ĞµĞ½Ğ½Ğ¸Ğ¹ Ğ¾Ñ‚ÑÑ‚ÑƒĞ¿      */
          margin:16px auto 26px;     /* Ñ‚Ğµ Ğ¶Ğµ Ğ¾Ñ‚ÑÑ‚ÑƒĞ¿Ñ‹          */
          box-sizing:content-box;
        }
        /* ÑĞµÑ€Ğ°Ñ Â«Ñ€ĞµĞ»ÑŒÑĞ°Â» Ğ¸ ÑĞ¸Ğ½Ğ¸Ğ¹ connect-Ğ±Ğ°Ñ€ */
        #yearSlider .noUi-base      {background:#bfbfbf;width:100%;height:100%;}
        #yearSlider .noUi-connect   {background:#bfbfbf;}


				.slider-reset-btn{
					display:block;
					width:100%;
					margin-top:4px;
					padding:2px 4px;
					font-size:11px;
					border:1px solid #bbb;
					background:#f5f5f5;
					border-radius:3px;
					cursor:pointer;
				}
				.slider-reset-btn:hover{ background:#eaeaea; }

				.loading-overlay{
					position:absolute;
					top:50%;left:50%;
					transform:translate(-50%,-50%);
					z-index:3000;
					pointer-events:none;
				}
				.spinner{
					width:40px;height:40px;
					border:4px solid rgba(0,0,0,.15);
					border-top:4px solid #1e88e5;
					border-radius:50%;
					animation:spin 1s linear infinite;
				}
				@keyframes spin{ to{ transform:rotate(360deg); } }


		</style>

		<!-- Ğ¡ĞºÑ€Ğ¸Ğ¿Ñ‚ Ğ¿ĞµÑ€ĞµĞ²Ğ¾Ğ´Ğ¾Ğ² -->
		<script id="translations-script">
			// ĞĞ±ÑŠĞµĞºÑ‚ Ğ¿ĞµÑ€ĞµĞ²Ğ¾Ğ´Ğ¾Ğ², Ğ¿ĞµÑ€ĞµĞ´Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ¸Ğ· Go
			var translations = JSON.parse('{{ .Translations | toJSON }}');
				var currentLang = '{{ .Lang }}'; // Ğ¢ĞµĞºÑƒÑ‰Ğ¸Ğ¹ ÑĞ·Ñ‹Ğº

				// Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ğ¿ĞµÑ€ĞµĞ²Ğ¾Ğ´Ğ° Ğ¿Ğ¾ ĞºĞ»ÑÑ‡Ñƒ
				function translate(key) {
						if (!translations['en']) {
								console.error('English translations not available!');
								return key;
						}

						if (translations[currentLang] && translations[currentLang][key]) {
								return translations[currentLang][key];
						} else if (translations['en'][key]) {
								return translations['en'][key];
						}
						return key;
				}
		</script>
		<script>
			const defaultCfg = {
				lat:  {{printf "%.6f" .DefaultLat}},
				lon:  {{printf "%.6f" .DefaultLon}},
				zoom: {{.DefaultZoom}},
				layer: {{.DefaultLayer}}
			};
		</script>

	</head>

	<body>

		<!-- ĞšĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€ Ğ´Ğ»Ñ ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ² -->
		<div class="upload-btn-container leaflet-control">
			<!--
		 title/aria-label â†’ ĞºĞ¾Ñ€Ğ¾Ñ‚ĞºĞ°Ñ Ğ¿Ğ¾Ğ´ÑĞºĞ°Ğ·ĞºĞ° Ğ½Ğ° hover/focus Ğ¾ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ°Ñ…
		 Ğ¸ Ñ‚Ğ¾Ğ¼, Ñ‡Ñ‚Ğ¾ Ğ¿Ñ€Ğ¾Ğ¸Ğ·Ğ¾Ğ¹Ğ´Ñ‘Ñ‚ Ğ¿Ğ¾ÑĞ»Ğµ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸.
			-->
			<label
				for="fileInput"
				class="upload-btn"
				title="{{translate "upload_button_tooltip"}}"
				aria-label="{{translate "upload_button_tooltip"}}">
				{{translate "upload_button"}}
			</label>

			<input
				type="file"
				id="fileInput"
				style="display: none;"
				multiple
				accept=""
				onchange="uploadFiles()">
		</div>

		<!-- ĞšĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€ Ğ´Ğ»Ñ ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ Ğ³ĞµĞ¾Ğ»Ğ¾ĞºĞ°Ñ†Ğ¸Ğ¸ -->
		<div class="locate-btn-container leaflet-control">
			<button id="locateButton" class="locate-btn" title="{{translate "locate_button_tooltip"}}">
				<img src="/static/images/marker-icon-2x.png" alt="Locate" style="width: 20px;">
			</button>
		</div>

		<!-- ĞšĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€ Ğ´Ğ»Ñ ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ "Ğ’ĞµÑ€Ğ½ÑƒÑ‚ÑŒÑÑ ĞºĞ¾ Ğ²ÑĞµĞ¼ Ñ‚Ñ€ĞµĞºĞ°Ğ¼" -->
		<div class="back-to-all-container leaflet-control" style="display: none;">
			<button id="backToAllButton" class="back-to-all-btn">{{ translate "back_to_all_tracks" }}</button>
		</div>

		<!-- ĞĞ²ĞµÑ€Ğ»ĞµĞ¹ Ğ´Ğ»Ñ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ² -->
		<div id="fileOverlay" style="display: none;">
			<div id="fileProgressContainer">
				<!-- ĞŸÑ€Ğ¾Ğ³Ñ€ĞµÑÑ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ² Ğ±ÑƒĞ´ĞµÑ‚ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑÑ‚ÑŒÑÑ ÑÑĞ´Ğ° Ğ´Ğ¸Ğ½Ğ°Ğ¼Ğ¸Ñ‡ĞµÑĞºĞ¸ -->
			</div>
		</div>

		<!-- Ğ¡ÑÑ‹Ğ»ĞºĞ° Ğ½Ğ° GitHub Ğ¸ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğµ -->
		<a href="https://github.com/matveynator/chicha-isotope-map" class="github-link" target="_blank">
			<img src="/static/images/GitHub-Mark.png" alt="GitHub" class="github-icon">
		</a>

		<div class="program-info">
			<a href="https://github.com/matveynator/chicha-isotope-map/releases/tag/latest" target="_blank"><strong>{{translate "description"}}</strong> (version: {{ .Version }})</a>
		</div>

		<!-- ĞšĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€ Ğ´Ğ»Ñ ĞºĞ°Ñ€Ñ‚Ñ‹ -->
		<div id="map"></div>

		<div id="loadingOverlay" class="loading-overlay" style="display:none;">
			<div class="spinner"></div>
		</div>


		<!-- ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ JavaScript Ğ±Ğ¸Ğ±Ğ»Ğ¸Ğ¾Ñ‚ĞµĞºĞ¸ Leaflet -->
		<script src="/static/leaflet.js"></script>

    <!-- Slider -->
    <script src="/static/nouislider.min.js"></script>
    <script src="/static/wNumb.min.js"></script>



		<!-- Ğ’ÑĞ¿Ğ¾Ğ¼Ğ¾Ğ³Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸ -->
		<script>
			// Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ´Ğ»Ñ Ñ€Ğ°ÑÑ‡Ñ‘Ñ‚Ğ° Ñ†Ğ²ĞµÑ‚Ğ° Ğ¼Ğ°Ñ€ĞºĞµÑ€Ğ° Ğ½Ğ° Ğ¾ÑĞ½Ğ¾Ğ²Ğµ ÑƒÑ€Ğ¾Ğ²Ğ½Ñ Ñ€Ğ°Ğ´Ğ¸Ğ°Ñ†Ğ¸Ğ¸
			function getGradientColor(doseRate) {
				if (doseRate <= 0.04) return "#006400"; // Ğ¢Ñ‘Ğ¼Ğ½Ğ¾-Ğ·ĞµĞ»Ñ‘Ğ½Ñ‹Ğ¹
				else if (doseRate <= 0.08) return interpolateColor([0, 100, 0], [173, 255, 47], (doseRate - 0.04) / (0.08 - 0.04));
				else if (doseRate <= 0.11) return interpolateColor([173, 255, 47], [255, 255, 0], (doseRate - 0.08) / (0.11 - 0.08));
				else if (doseRate <= 0.20) return interpolateColor([255, 255, 0], [255, 165, 0], (doseRate - 0.11) / (0.20 - 0.11));
				else if (doseRate <= 0.30) return interpolateColor([255, 165, 0], [255, 0, 0], (doseRate - 0.20) / (0.30 - 0.20));
				else if (doseRate <= 0.99) return interpolateColor([255, 0, 0], [0, 0, 0], (doseRate - 0.30) / (0.99 - 0.30));
				else return "#000000"; // Ğ§Ñ‘Ñ€Ğ½Ñ‹Ğ¹ Ğ´Ğ»Ñ Ğ¾Ñ‡ĞµĞ½ÑŒ Ğ²Ñ‹ÑĞ¾ĞºĞ¸Ñ… Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğ¹
			}

// Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ¸Ğ½Ñ‚ĞµÑ€Ğ¿Ğ¾Ğ»ÑÑ†Ğ¸Ğ¸ Ğ¼ĞµĞ¶Ğ´Ñƒ Ğ´Ğ²ÑƒĞ¼Ñ Ñ†Ğ²ĞµÑ‚Ğ°Ğ¼Ğ¸
function interpolateColor(color1, color2, factor) {
	if (factor < 0) factor = 0;
	if (factor > 1) factor = 1;

	const r = Math.round(color1[0] + (color2[0] - color1[0]) * factor);
	const g = Math.round(color1[1] + (color2[1] - color1[1]) * factor);
	const b = Math.round(color1[2] + (color2[2] - color1[2]) * factor);

	return `rgb(${r}, ${g}, ${b})`;
}

// Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ´Ğ»Ñ Ñ€Ğ°ÑÑ‡Ñ‘Ñ‚Ğ° Ñ€Ğ°Ğ´Ğ¸ÑƒÑĞ° Ğ¼Ğ°Ñ€ĞºĞµÑ€Ğ° Ğ½Ğ° Ğ¾ÑĞ½Ğ¾Ğ²Ğµ ÑƒÑ€Ğ¾Ğ²Ğ½Ñ Ğ·ÑƒĞ¼Ğ°
function getRadius(doseRate, zoomLevel) {
	// Ñ€Ğ°Ğ½ÑŒÑˆĞµ: Math.pow(2, (zoomLevel-10)/2)
	const k = 1.8;                               // Ğ¼Ğ°ÑÑˆÑ‚Ğ°Ğ±Ğ¸Ñ€ÑƒĞµĞ¼ ~Ã—2
	let r   = Math.pow(2, (zoomLevel - 10)/2) * k;
	return Math.max(r, 2);                       // Ğ·Ğ°Ñ‰Ğ¸Ñ‚Ğ° Ğ¾Ñ‚ ÑĞ»Ğ¸ÑˆĞºĞ¾Ğ¼ Ğ¼ĞµĞ»ĞºĞ¸Ñ…
}


/**
 * Decide whether the marker with given speed (m/s)
 * should be displayed according to current speed-filter state.
 * Ğ’ Ñ€ĞµĞ¶Ğ¸Ğ¼Ğµ Ğ¿Ñ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ° ĞĞ”ĞĞĞ“Ğ Ñ‚Ñ€ĞµĞºĞ° Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸ Ğ½ĞµÑ‚ â€” Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ²ÑÑ‘.
 */
function shouldDisplayBySpeed(speed) {
    /* â”€â”€ ĞºĞ»ÑÑ‡ĞµĞ²Ğ°Ñ ÑÑ‚Ñ€Ğ¾ĞºĞ° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    if (isTrackView) return true;        // â† NEW: Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€ Ğ¾Ñ‚ĞºĞ»ÑÑ‡Ñ‘Ğ½

    const st = loadSpeedFilterState();   // Ğ³Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ñ€ĞµĞ¶Ğ¸Ğ¼
    if (speed >= 70 && speed <= 500) return st.plane;  // âœˆï¸
    if (speed >= 7  && speed <  70)  return st.car;    // ğŸš—
    /* speed < 7 m/s  â†’ pedestrian */
    return st.ped;                                      // ğŸš¶
}


// Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ´Ğ»Ñ Ñ€Ğ°ÑÑ‡Ñ‘Ñ‚Ğ° Ğ¿Ñ€Ğ¾Ğ·Ñ€Ğ°Ñ‡Ğ½Ğ¾ÑÑ‚Ğ¸ Ğ·Ğ°Ğ»Ğ¸Ğ²ĞºĞ¸ Ğ¼Ğ°Ñ€ĞºĞµÑ€Ğ° Ğ½Ğ° Ğ¾ÑĞ½Ğ¾Ğ²Ğµ ÑĞºĞ¾Ñ€Ğ¾ÑÑ‚Ğ¸
function getFillOpacity(speed) {
	if (speed <= 5) {
		return 0.6;
	} else if (speed >= 20) {
		return 0.1;
	} else {
		var opacityRange = 0.6 - 0.1;
		var speedRange = 20 - 5;
		var opacityDecreasePerMs = opacityRange / speedRange;
		var speedAboveFive = speed - 5;
		var totalOpacityDecrease = speedAboveFive * opacityDecreasePerMs;
		var currentOpacity = 0.6 - totalOpacityDecrease;
		return currentOpacity;
	}
}

// Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ğ¼Ğ¾Ğ³Ğ¾ Ğ²ÑĞ¿Ğ»Ñ‹Ğ²Ğ°ÑÑ‰ĞµĞ³Ğ¾ Ğ¾ĞºĞ½Ğ° Ğ¼Ğ°Ñ€ĞºĞµÑ€Ğ°
function getTooltipContent(marker) {
	var date = new Date(marker.date * 1000);
	var formattedDate = date.toLocaleString();

	return `
		<div class="custom-tooltip">
		<div class="tooltip-row">
		<strong>${translate('radiation_dose')}:</strong>
		<span>${(marker.doseRate * 100).toFixed(2)} ÂµR/h (${marker.doseRate.toFixed(2)} ÂµSv/h)</span>
		</div>
		<div class="tooltip-row">
		<strong>${translate('speed')}:</strong>
		<span>${(marker.speed * 3.6).toFixed(1)} km/h</span>
		</div>
		<div class="tooltip-row">
		<strong>${translate('track_id')}:</strong>
		<span>${marker.trackID}</span>
		</div>
		</div>
		`;
}

// Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ñ… Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ğ¾Ğ² URL Ğ½Ğ° Ğ¾ÑĞ½Ğ¾Ğ²Ğµ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ ĞºĞ°Ñ€Ñ‚Ñ‹
function getCurrentUrlParams() {
	var bounds = map.getBounds();
	var layer = map.hasLayer(googleSatellite) ? 'Google Satellite' : 'OpenStreetMap';
	var minLat = bounds.getSouthWest().lat.toFixed(5);
	var minLon = bounds.getSouthWest().lng.toFixed(5);
	var maxLat = bounds.getNorthEast().lat.toFixed(5);
	var maxLon = bounds.getNorthEast().lng.toFixed(5);
	var zoom = map.getZoom();

	return `?minLat=${minLat}&minLon=${minLon}&maxLat=${maxLat}&maxLon=${maxLon}&zoom=${zoom}&layer=${encodeURIComponent(layer)}`;
}
		</script>

		<!-- Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ ĞºĞ°Ñ€Ñ‚Ñ‹ Ğ¸ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ° Ñ Ğ¼Ğ°Ñ€ĞºĞµÑ€Ğ°Ğ¼Ğ¸ -->
		<script>
			var map;
var circleMarkers = {};
var isTrackView = false;
var osmLayer, googleSatellite;
var trackBounds;
var currentTrackID = null;

// âœ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ ĞºĞ¾Ğ½Ñ‚Ñ€Ğ¾Ğ»Ğ»ĞµÑ€, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¾Ñ‚Ğ¼ĞµĞ½ÑÑ‚ÑŒ Ğ¿Ñ€ĞµĞ´Ñ‹Ğ´ÑƒÑ‰Ğ¸Ğ¹ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ
var markerFetchController = null;


/**
 * Load previously saved speed-filter state from sessionStorage.
 * If nothing is stored yet, return default state
 *   âœˆï¸ off, ğŸš— on, ğŸš¶ on  (as requested).
 */
function loadSpeedFilterState() {
	const def = { plane: false, car: true, ped: true };
	try {
		const raw = sessionStorage.getItem('speedFilterState');
		return raw ? JSON.parse(raw) : def;
	} catch (e) {
		return def;
	}
}

// ---------- helpers for time-range state ------------------------
function loadDateRangeState() {
	try { return JSON.parse(sessionStorage.getItem('dateRangeState')) || null; }
	catch(e){ return null; }
}
function saveDateRangeState(st) {
	sessionStorage.setItem('dateRangeState', JSON.stringify(st));
}

/**
 * Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ ÑÑ‚Ñ€Ğ¾ĞºÑƒ Â«ĞœĞµÑÑÑ† Ğ“Ğ“Ğ“Ğ“Â» Ğ½Ğ° ÑĞ·Ñ‹ĞºĞµ Ğ±Ñ€Ğ°ÑƒĞ·ĞµÑ€Ğ°
 * (Ğ½Ğ° Ğ±Ğ¾Ğ»ÑŒÑˆĞ¸Ğ½ÑÑ‚Ğ²Ğµ ÑƒÑÑ‚Ñ€Ğ¾Ğ¹ÑÑ‚Ğ² Chrome/Firefox Ğ²Ñ‹Ğ´Ğ°ÑÑ‚ Â«ĞĞ²Ğ³ 2025Â»,
 * Safari â€” Â«Aug 2025Â» Ğ¸ Ñ‚.Ğ´.).
 */
function tsToNiceStr(ts){
    return new Date(ts * 1000)
        .toLocaleDateString(undefined, { month: 'short', year: 'numeric' });
}


// Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ |diff| Ğ² Ğ¼ĞµÑÑÑ†Ğ°Ñ… Ğ¼ĞµĞ¶Ğ´Ñƒ Ğ´Ğ²ÑƒĞ¼Ñ unix-ÑĞµĞºÑƒĞ½Ğ´Ğ°Ğ¼Ğ¸
function monthsApart(ts0, ts1){
    const d0 = new Date(ts0 * 1000);
    const d1 = new Date(ts1 * 1000);
    return Math.abs((d1.getFullYear() - d0.getFullYear()) * 12 +
                    (d1.getMonth()     - d0.getMonth()));
}

/**
 * Persist current speed-filter state into sessionStorage
 * so the userâ€™s choice is remembered for the whole session.
 */
function saveSpeedFilterState(state) {
	sessionStorage.setItem('speedFilterState', JSON.stringify(state));
}


document.addEventListener('DOMContentLoaded', function () {

	// Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ trackID Ğ¿Ğ¾ Ğ¿ÑƒÑ‚Ğ¸
	var match = window.location.pathname.match(/^\/trackid\/([a-zA-Z0-9]+)/);
	if (match) {
		currentTrackID = match[1];
		isTrackView = true;
		// <<< ĞĞĞ’ĞĞ•: ÑÑ€Ğ°Ğ·Ñƒ Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ ĞºĞ½Ğ¾Ğ¿ĞºÑƒ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚Ğ° >>>
		var backBox = document.querySelector('.back-to-all-container');
		if (backBox) backBox.style.display = 'block';
	}
	// Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ ÑĞ»Ğ¾Ñ‘Ğ² ĞºĞ°Ñ€Ñ‚Ñ‹
	osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
		maxZoom: 18,
		attribution: '&copy; OpenStreetMap contributors'
	});

	googleSatellite = L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
		maxZoom: 20,
		attribution: '&copy; Google'
	});

	// ÑÑ€Ğ°Ğ·Ñƒ Ğ¿Ğ¾ÑĞ»Ğµ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ osmLayer Ğ¸ googleSatellite
	const urlParams       = new URLSearchParams(window.location.search);
	const startLayerName  = decodeURIComponent(urlParams.get('layer') || defaultCfg.layer);
	const startLayer      = startLayerName === 'Google Satellite' ? googleSatellite : osmLayer;

	map = L.map('map', {
		center: [defaultCfg.lat, defaultCfg.lon],
		zoom  : defaultCfg.zoom,
		layers: [startLayer],           // Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¾Ğ´Ğ¸Ğ½ Ğ±Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğ¹ ÑĞ»Ğ¾Ğ¹
	});

	// ĞšĞ¾Ğ½Ñ‚Ñ€Ğ¾Ğ»Ğ»ĞµÑ€ ÑĞ»Ğ¾Ñ‘Ğ²
	var baseLayers = {
		"OpenStreetMap": osmLayer,
		"Google Satellite": googleSatellite
	};

	L.control.layers(baseLayers, null, {
		position: 'topleft',
		collapsed: false
	}).addTo(map);

	// Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ñ€ĞµĞ¶Ğ¸Ğ¼Ğ° Ğ¿Ñ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ° Ñ‚Ñ€ĞµĞºĞ°
	var initialMarkers = JSON.parse('{{ .Markers | toJSON }}');
	if (Array.isArray(initialMarkers) && initialMarkers.length > 0) {
		isTrackView = true;

		// ĞĞµ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶Ğ°ĞµĞ¼ initialMarkers ÑÑ€Ğ°Ğ·Ñƒ, Ğ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ Ğ¿Ğ¾ Ñ‡Ğ°ÑÑ‚ÑĞ¼ Ñ‡ĞµÑ€ĞµĞ· get_markers
		map.on('load', debounceUpdateMarkers);

		// Ğ˜Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ Ñ€Ğ°Ğ·Ğ¼ĞµÑ€Ğ¾Ğ² Ğ¼Ğ°Ñ€ĞºĞµÑ€Ğ¾Ğ² Ğ¿Ñ€Ğ¸ Ğ·ÑƒĞ¼Ğµ
		map.on('zoomend', function() {
			adjustMarkerRadius();
			debounceUpdateMarkers();
		});
		map.on('moveend', debounceUpdateMarkers);
	} else {
		// Ğ”Ğ¸Ğ½Ğ°Ğ¼Ğ¸Ñ‡ĞµÑĞºĞ¾Ğµ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¼Ğ°Ñ€ĞºĞµÑ€Ğ¾Ğ² Ğ² Ğ³Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ğ¾Ğ¼ Ñ€ĞµĞ¶Ğ¸Ğ¼Ğµ
		map.on('load', debounceUpdateMarkers);
		map.on('zoomend', function() {
			adjustMarkerRadius();
			debounceUpdateMarkers();
		});
		map.on('moveend', debounceUpdateMarkers);
		debounceUpdateMarkers;
	}

	// Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ ĞºĞ°Ñ€Ñ‚Ñ‹ Ğ¸Ğ· URL
	loadMapFromUrl();

	// ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ URL Ğ¿Ñ€Ğ¸ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸ÑÑ… Ğ½Ğ° ĞºĞ°Ñ€Ñ‚Ğµ
	map.on('baselayerchange', updateUrl);
	map.on('moveend', updateUrl);
	map.on('zoomend', updateUrl);

	// Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚Ğ¾Ğ² Ğ¸Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹ÑĞ°
	initializeUIElements();

	/**
	 * Build a Leaflet control with three check-boxes that filter markers
	 * by recorded speed. Labels now show speed in km/h instead of m/s.
	 * Default state: âœˆï¸ off, ğŸš— on, ğŸš¶ on.
	 */
	function createSpeedFilterControls() {

     if (isTrackView) return;   //Ğ½Ğµ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶Ğ°ĞµĞ¼ Ğ² Ñ€ĞµĞ¶Ğ¸Ğ¼Ğµ Ñ‚Ñ€ĞµĞºĞ°

		// load previously saved state (or defaults)
		const state = loadSpeedFilterState();

		// custom Leaflet control
		const SpeedCtrl = L.Control.extend({
			onAdd() {
				const div = L.DomUtil.create('div', 'leaflet-control-layers');
				div.style.padding = '6px 10px';

				// helper that returns one <label> line
				const row = (id, emoji, checked) => `
						<label style="white-space:nowrap;display:block;cursor:pointer;">
						<input id="${id}" type="checkbox" ${checked ? 'checked' : ''}/>
					${emoji}
						</label>`;

				// order: âœˆï¸, ğŸš—, ğŸš¶  (top â†’ bottom)
				div.innerHTML =
					row('sfPlane', 'âœˆï¸',  state.plane) +
					row('sfCar',   'ğŸš—', state.car)   +
					row('sfPed',   'ğŸš¶', state.ped);

				// prevent map drag/zoom while clicking inside the control
				L.DomEvent.disableClickPropagation(div);

				// attach change-handlers
				div.querySelectorAll('input[type=checkbox]').forEach(cb => {
					cb.addEventListener('change', () => {
						state.plane = div.querySelector('#sfPlane').checked;
						state.car   = div.querySelector('#sfCar').checked;
						state.ped   = div.querySelector('#sfPed').checked;
						saveSpeedFilterState(state);   // remember choice
						debounceUpdateMarkers();       // redraw with new filter
					});
				});

				return div;
			}
		});

		new SpeedCtrl({ position: 'topleft' }).addTo(map);
	}






	// Call it
	createSpeedFilterControls();   
	createDateRangeSlider();


});


/**
 * createDateRangeSlider()
 *  â€¢ Ğ’ĞµÑ€Ñ‚Ğ¸ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ double-slider (Ğ¼ĞµÑÑÑ†Ñ‹) Ğ˜ single-slider (Ğ³Ğ¾Ğ´Ñ‹)
 *  â€¢ ĞŸĞµÑ€ĞµĞºĞ»ÑÑ‡Ğ°Ñ‚ĞµĞ»ÑŒ Y / M
 *  â€¢ Ğ“Ğ¾Ğ´Ğ¾Ğ²Ğ¾Ğ¹ Ñ€ĞµĞ¶Ğ¸Ğ¼ â€” Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ
 */
function createDateRangeSlider(){

  if (isTrackView) return;   //Ğ½Ğµ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶Ğ°ĞµĞ¼ Ğ² Ñ€ĞµĞ¶Ğ¸Ğ¼Ğµ Ñ‚Ñ€ĞµĞºĞ°

	/* â”€â”€ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
	let sliderBox, yearSlider, monthSlider;
	let mode  = 'year';                      // 'year' | 'month'
	let initY = false, initM = false;        // lazy-init Ñ„Ğ»Ğ°Ğ³Ğ¸

	/* â”€â”€ Leaflet-ĞºĞ¾Ğ½Ñ‚Ñ€Ğ¾Ğ» â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
	const DateCtrl = L.Control.extend({
		onAdd(){
			sliderBox = L.DomUtil.create('div',
			  'leaflet-control-layers date-slider-box');
      sliderBox.style.display = 'none';   // Ğ¿Ğ¾ĞºĞ° Ğ½Ğµ Ğ½ÑƒĞ¶Ğ½Ğ¾
			sliderBox.innerHTML = `
				<div class="slider-toggle">
				<button id="btnYear"  class="active">Y</button>
				<button id="btnMonth">M</button>
				</div>
				<div id="lblMax" class="slider-label"></div>
				<div id="yearSlider"></div>
				<div id="dateSlider"></div>
				<div id="lblMin" class="slider-label"></div>
				<!-- â–¼ ĞĞĞ’ĞĞ•: ĞºĞ½Ğ¾Ğ¿ĞºĞ° ÑĞ±Ñ€Ğ¾ÑĞ° Ğ´Ğ¸Ğ°Ğ¿Ğ°Ğ·Ğ¾Ğ½Ğ° â–¼ -->
				<button id="btnReset" class="slider-reset-btn" title="Reset">âŸ² {{translate "show_all"}}</button>
				<!-- â–² ĞĞĞ’ĞĞ• â–² -->
			`;

			return sliderBox;
		}
	});
	new DateCtrl({ position:'topleft' }).addTo(map);

	/* â”€â”€â”€â”€â”€â”€â”€â”€â”€ Ğ¿ĞµÑ€ĞµĞºĞ»ÑÑ‡Ğ°Ñ‚ĞµĞ»ÑŒ Ñ€ĞµĞ¶Ğ¸Ğ¼Ğ¾Ğ² â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
	const btnY = sliderBox.querySelector('#btnYear');
	const btnM = sliderBox.querySelector('#btnMonth');
	btnY.onclick = () => switchMode('year');
	btnM.onclick = () => switchMode('month');


	const btnReset = sliderBox.querySelector('#btnReset');

	/* â”€â”€â”€â”€â”€â”€â”€â”€â”€ ĞºĞ½Ğ¾Ğ¿ĞºĞ° Â«âŸ² ResetÂ» â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
		btnReset.onclick = () => {
			// ÑĞ±Ñ€Ğ°ÑÑ‹Ğ²Ğ°ĞµĞ¼ ÑĞ¾Ñ…Ñ€Ğ°Ğ½Ñ‘Ğ½Ğ½Ñ‹Ğ¹ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€
			sessionStorage.removeItem('dateRangeState');

			// --- Ğ³Ğ¾Ğ´Ğ¾Ğ²Ğ¾Ğ¹ ÑĞ»Ğ°Ğ¹Ğ´ĞµÑ€ ----------------------------------
			if (initY) {
				const rY = yearSlider.noUiSlider.options.range;
				yearSlider.noUiSlider.set(rY.min);          // Ñ€ÑƒÑ‡ĞºĞ° Ğº ÑĞ°Ğ¼Ğ¾Ğ¼Ñƒ Ğ½Ğ°Ñ‡Ğ°Ğ»Ñƒ
			}

			// --- Ğ¼ĞµÑÑÑ‡Ğ½Ñ‹Ğ¹ ÑĞ»Ğ°Ğ¹Ğ´ĞµÑ€  (Ğ²Ğ°Ğ¶Ğ½Ğ¾: Ğ²ÑĞµĞ³Ğ´Ğ°, Ğ´Ğ°Ğ¶Ğµ ĞµÑĞ»Ğ¸ ÑĞµĞ¹Ñ‡Ğ°Ñ ÑĞºÑ€Ñ‹Ñ‚)
			if (initM) {
				const rM = monthSlider.noUiSlider.options.range;
				monthSlider.noUiSlider.set([rM.min, rM.max]);
			}

			// --- Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ¸ Ğ²Ğ½Ğ¸Ğ·Ñƒ/Ğ²Ğ²ĞµÑ€Ñ…Ñƒ ------------------------------
			const lblMin = sliderBox.querySelector('#lblMin');
			const lblMax = sliderBox.querySelector('#lblMax');

			if (mode === 'year') {                        // Ğ°ĞºÑ‚Ğ¸Ğ²ĞµĞ½ Ğ³Ğ¾Ğ´Ğ¾Ğ²Ğ¾Ğ¹
				const r = yearSlider.noUiSlider.options.range;
				lblMin.textContent = r.min;
				lblMax.textContent = r.max;
			} else {                                      // Ğ°ĞºÑ‚Ğ¸Ğ²ĞµĞ½ Ğ¼ĞµÑÑÑ‡Ğ½Ñ‹Ğ¹
				const r = monthSlider.noUiSlider.options.range;
				lblMin.textContent = tsToNiceStr(r.min);
				lblMax.textContent = tsToNiceStr(r.max);
			}

			debounceUpdateMarkers();
		};


	/* â”€â”€â”€â”€â”€â”€â”€â”€â”€ Ğ¿ĞµÑ€ĞµĞºĞ»ÑÑ‡Ğ°Ñ‚ĞµĞ»ÑŒ Ñ€ĞµĞ¶Ğ¸Ğ¼Ğ¾Ğ² â”€â”€â”€â”€â”€â”€â”€â”€â”€ */


		/* â”€â”€â”€â”€â”€â”€â”€â”€â”€ Ğ¿ĞµÑ€ĞµĞºĞ»ÑÑ‡Ğ°Ñ‚ĞµĞ»ÑŒ Ñ€ĞµĞ¶Ğ¸Ğ¼Ğ¾Ğ² â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
		function switchMode(next){
			/* â€•â€• ĞµÑĞ»Ğ¸ Ñ€ĞµĞ¶Ğ¸Ğ¼ Ğ½Ğµ Ğ¼ĞµĞ½ÑĞµÑ‚ÑÑ, Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ¸Ğ¼ â€•â€• */
				if (mode === next) return;

			const lblMin = sliderBox.querySelector('#lblMin');
			const lblMax = sliderBox.querySelector('#lblMax');

			/* ---------- PATCH 2025-07-30 v2 ---------- */
				let skipFilter = false;                       // Ğ½Ğµ Ğ²Ñ‹Ğ·Ñ‹Ğ²Ğ°Ñ‚ÑŒ updateDateFilter()?
				if (next === 'year' && initY){                // Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ¸Ğ¼ Ğ² Y-mode
					const saved = loadDateRangeState();       // Ñ‡Ñ‚Ğ¾ ÑĞµĞ¹Ñ‡Ğ°Ñ Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑÑ?
						if (saved && initM){                      // ĞµÑÑ‚ÑŒ Ğ´Ğ¸Ğ°Ğ¿Ğ°Ğ·Ğ¾Ğ½ â†’ ÑÑ€Ğ°Ğ²Ğ½Ğ¸Ğ¼
							const rM   = monthSlider.noUiSlider.options.range;
							const full = saved[0] === rM.min && saved[1] === rM.max;
							if (full){                            // ĞºĞ°Ñ€Ñ‚Ğ° Â«ÑĞ±Ñ€Ğ¾ÑˆĞµĞ½Ğ°Â»
								const rY = yearSlider.noUiSlider.options.range;
								yearSlider.noUiSlider.set(rY.min);   // Ñ‡Ğ¸ÑÑ‚Ğ¾ Ğ²Ğ¸Ğ·ÑƒĞ°Ğ»ÑŒĞ½Ğ¾
								lblMin.textContent = rY.min;         // Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ¸ = Ğ²ĞµÑÑŒ Ğ´Ğ¸Ğ°Ğ¿Ğ°Ğ·Ğ¾Ğ½ Ğ»ĞµÑ‚
								lblMax.textContent = rY.max;
								skipFilter = true;                   // Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€ Ğ½Ğµ Ğ¼ĞµĞ½ÑĞµĞ¼
							}else{                                // Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½ ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ñ‹Ğ¹ Ğ³Ğ¾Ğ´
								const y = new Date(saved[0] * 1000).getUTCFullYear();
								yearSlider.noUiSlider.set(y);        // ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµĞ¼ Ğ±ĞµĞ³ÑƒĞ½Ğ¾Ğº
								lblMin.textContent = y;
								lblMax.textContent = y;
							}
						}else{                                    // saved == null â†’ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ° Ğ½ĞµÑ‚
							const rY = yearSlider.noUiSlider.options.range;
							yearSlider.noUiSlider.set(rY.min);
							lblMin.textContent = rY.min;
							lblMax.textContent = rY.max;
							skipFilter = true;
						}
				}
			/* ----------------------------------------- */

				/* â€”â€”â€” Ğ°Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ¸Ñ‡Ğ½Ğ°Ñ ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ¿Ñ€Ğ¸ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğµ Y â†’ M (Ğ¾ÑÑ‚Ğ°Ğ»Ğ°ÑÑŒ ĞºĞ°Ğº Ñ€Ğ°Ğ½ÑŒÑˆĞµ) â€”â€”â€” */
				if (next === 'month' && initM){
					const saved = loadDateRangeState();
					if (saved){
						monthSlider.noUiSlider.set(saved);
					}else{
						const r = monthSlider.noUiSlider.options.range;
						monthSlider.noUiSlider.set([r.min, r.max]);
					}
					const [v0, v1] = monthSlider.noUiSlider.get().map(Number);
					lblMin.textContent = tsToNiceStr(v0);
					lblMax.textContent = tsToNiceStr(v1);
				}

			/* â€•â€• Ğ²Ğ¸Ğ·ÑƒĞ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ¿ĞµÑ€ĞµĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ â€•â€• */
				mode = next;
			btnY.classList.toggle('active', next === 'year');
			btnM.classList.toggle('active', next === 'month');
			yearSlider.style.display  = next === 'year'  ? 'block' : 'none';
			monthSlider.style.display = next === 'month' ? 'block' : 'none';

			/* â€•â€• Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½ÑĞµĞ¼ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€, ĞµÑĞ»Ğ¸ Ğ½ÑƒĞ¶Ğ½Ğ¾ â€•â€• */
				if (!skipFilter) updateDateFilter();
		}


	/* â”€â”€ Ğ¿Ğ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ / ÑĞºÑ€Ñ‹Ñ‚ÑŒ ĞºĞ¾Ñ€Ğ¾Ğ±ĞºÑƒ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
	let visible = false;
	window.__setDateSliderVisibility = show=>{
		if(show === visible) return;
		visible = show;
		sliderBox.style.display = show ? 'block' : 'none';
		if(!show) sessionStorage.removeItem('dateRangeState');
	};

	/* â”€â”€ Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ noUiSlider-Ğ¾Ğ² (Ğ»ĞµĞ½Ğ¸Ğ²Ğ°Ñ) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
	window.__initSliderOnce = (minTs, maxTs)=>{
		const lblMin = sliderBox.querySelector('#lblMin');
		const lblMax = sliderBox.querySelector('#lblMax');

		/* YEAR-slider (Ğ¾Ğ´Ğ¸Ğ½ Ğ±ĞµĞ³ÑƒĞ½Ğ¾Ğº) */
		if(!initY){
			yearSlider = sliderBox.querySelector('#yearSlider');
			const minYear = new Date(minTs*1000).getUTCFullYear();
			const maxYear = new Date(maxTs*1000).getUTCFullYear();
			const stored  = loadDateRangeState() || [(minYear|0)];
			noUiSlider.create(yearSlider,{
				start      : stored[0],
				connect    : [true,false],
				orientation: 'vertical',
				direction  : 'rtl',
				step       : 1,
				range      : { min:minYear, max:maxYear },
				format     : wNumb({ decimals:0 })
			});
			yearSlider.noUiSlider.on('update', ([y]) => {
				if (mode !== 'year') return;   // â† Ğ¸Ğ³Ğ½Ğ¾Ñ€ Ğ² Ñ€ĞµĞ¶Ğ¸Ğ¼Ğµ Ğ¼ĞµÑÑÑ†ĞµĞ²
				lblMin.textContent = y;
				lblMax.textContent = y;
			});
			yearSlider.noUiSlider.on('change',updateDateFilter);
			initY = true;
		}

		/* MONTH-slider (Ğ´Ğ²Ğ¾Ğ¹Ğ½Ğ¾Ğ¹) */
		if(!initM){
			monthSlider = sliderBox.querySelector('#dateSlider');
			const stored = loadDateRangeState() || [minTs, maxTs];
			noUiSlider.create(monthSlider,{
				start       : stored,
				connect     : true,
				orientation : 'vertical',
				direction   : 'rtl',
				step        : 3600,                 // 1 Ñ‡
				range       : { min:minTs, max:maxTs },
				format      : wNumb({ decimals:0 })
			});
			monthSlider.noUiSlider.on('update', () => {
				if (mode !== 'month') return;  // â† Ğ¸Ğ³Ğ½Ğ¾Ñ€ Ğ² Ñ€ĞµĞ¶Ğ¸Ğ¼Ğµ Ğ³Ğ¾Ğ´Ğ¾Ğ²
				const [v0, v1] = monthSlider.noUiSlider.get().map(Number);
				lblMin.textContent = tsToNiceStr(v0);
				lblMax.textContent = tsToNiceStr(v1);
			});
			monthSlider.noUiSlider.on('change',updateDateFilter);
			monthSlider.style.display = 'none';   // ÑĞºÑ€Ñ‹Ñ‚ Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ
			initM = true;
		}
	};

	/* â”€â”€ Ğ¿ĞµÑ€ĞµĞ²Ğ¾Ğ´ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ñ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ³Ğ¾ ÑĞ»Ğ°Ğ¹Ğ´ĞµÑ€Ğ° â†’ dateRangeState â”€ */
	function updateDateFilter(){
		let range;
		if(mode==='year'){
			const y = +yearSlider.noUiSlider.get();
			const from = Date.UTC(y,0,1)/1000;
			const to   = Date.UTC(y+1,0,1)/1000 - 1;
			range = [from,to];
		}else{
			range = monthSlider.noUiSlider.get().map(Number);
		}
		saveDateRangeState(range);
		debounceUpdateMarkers();
	}
}

	

// ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ğµ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¹

// ---------- POP-UP ÑĞ¾ ÑÑÑ‹Ğ»ĞºĞ¾Ğ¹ Ğ½Ğ° Ñ‚Ñ€ĞµĞº ----------
function getPopupContent(marker) {
	const dateStr = new Date(marker.date * 1000).toLocaleString();
	return `
		<div class="custom-tooltip">
		<div><strong>${translate('radiation_dose')}:</strong>
	${(marker.doseRate * 100).toFixed(2)} ÂµR/h (${marker.doseRate.toFixed(2)} ÂµSv/h)
		</div>
		<div><strong>${translate('speed')}:</strong> ${(marker.speed * 3.6).toFixed(1)} km/h</div>
		<div style="margin-top:4px">
		<!-- Ñ‰Ñ‘Ğ»Ğº Ğ¿Ğ¾ ÑÑÑ‹Ğ»ĞºĞµ = Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´ Ğ² Ñ€ĞµĞ¶Ğ¸Ğ¼ Ñ‚Ñ€ĞµĞºĞ° -->
		<a href="javascript:viewTrack('${marker.trackID}')" style="font-weight:bold;">
	${translate('track_id')}: ${marker.trackID}
		</a>
		</div>
		</div>`;
}


/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 *  updateMarkers () â€” Ğ·Ğ°Ğ¿Ñ€Ğ°ÑˆĞ¸Ğ²Ğ°ĞµÑ‚ Ğ¼Ğ°Ñ€ĞºĞµÑ€Ñ‹ Ğ´Ğ»Ñ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ³Ğ¾ Ğ¾ĞºĞ½Ğ° ĞºĞ°Ñ€Ñ‚Ñ‹,
 *  Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½ÑĞµÑ‚ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€ ÑĞºĞ¾Ñ€Ğ¾ÑÑ‚ĞµĞ¹ Ğ¸ Ñ€Ğ¸ÑÑƒĞµÑ‚ ĞºÑ€ÑƒĞ³Ğ¸.
 *  Ğ“Ğ»Ğ°Ğ²Ğ½Ğ¾Ğµ Ğ½Ğ¾Ğ²Ğ¾Ğ²Ğ²ĞµĞ´ĞµĞ½Ğ¸Ğµ: AbortController + Ğ°ĞºĞºÑƒÑ€Ğ°Ñ‚Ğ½Ñ‹Ğ¹ .catch().
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
function updateMarkers(){
	const loadingEl = document.getElementById('loadingOverlay');  // â¬… spinner
	if(loadingEl) loadingEl.style.display='block';                // â¬… spinner

    if (markerFetchController) markerFetchController.abort();
    markerFetchController = new AbortController();

    const zoom   = map.getZoom();
    const bounds = map.getBounds();

    const params = {
        zoom  : zoom,
        minLat: bounds.getSouthWest().lat,
        minLon: bounds.getSouthWest().lng,
        maxLat: bounds.getNorthEast().lat,
        maxLon: bounds.getNorthEast().lng
    };

    // --- âœˆğŸš—ğŸš¶ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€ ÑĞºĞ¾Ñ€Ğ¾ÑÑ‚ĞµĞ¹ -------------------------------
    if (!isTrackView) {            // <â”€â”€ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€ÑƒĞµĞ¼ Ğ¢ĞĞ›Ğ¬ĞšĞ Ğ² Ğ³Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ğ¾Ğ¼ Ñ€ĞµĞ¶Ğ¸Ğ¼Ğµ
      const sp = loadSpeedFilterState();
      const speeds = [];
      if (sp.plane) speeds.push('plane');
      if (sp.car)   speeds.push('car');
      if (sp.ped)   speeds.push('ped');
      if (speeds.length && speeds.length !== 3){
          params.speeds = speeds.join(',');
      }
    }

    // --- Ñ‚Ñ€ĞµĞºĞ¾Ğ²Ñ‹Ğ¹ Ñ€ĞµĞ¶Ğ¸Ğ¼ --------------------------------------
    if (isTrackView && currentTrackID){
        params.trackID = currentTrackID;
    }

    fetch('/get_markers?' + new URLSearchParams(params),
          { signal: markerFetchController.signal })
        .then(r => { if(!r.ok) throw new Error(`HTTP ${r.status}`); return r.json(); })
        .then(data => {
            if (!Array.isArray(data)) data = [];

            // ---- ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° Ğ¿Ğ¾ Ñ‚Ñ€ĞµĞºĞ°Ğ¼/Ğ´Ğ°Ñ‚Ğ°Ğ¼ -----------------
            const tracks = new Set();
            let minTs = Infinity, maxTs = -Infinity;
            data.forEach(m=>{
                if (m.trackID) tracks.add(m.trackID);
                minTs = Math.min(minTs, m.date);
                maxTs = Math.max(maxTs, m.date);
            });

            const dateSpanMonths = (isFinite(minTs) && isFinite(maxTs))
                                   ? monthsApart(minTs, maxTs) : 0;

            // Ğ½ÑƒĞ¶ĞµĞ½ Ğ»Ğ¸ ÑĞ»Ğ°Ğ¹Ğ´ĞµÑ€? (â‰¥2 Ñ‚Ñ€ĞµĞºĞ° Ğ˜ Ñ€Ğ°Ğ·Ğ±Ñ€Ğ¾Ñ > 1 Ğ¼ĞµÑÑÑ†)
            const needSlider = !isTrackView &&
                               tracks.size > 1 &&
                               dateSpanMonths > 1;

            if (window.__setDateSliderVisibility){
                window.__setDateSliderVisibility(needSlider);
            }

            // Ğ¿ĞµÑ€Ğ²Ğ¾Ğµ Ğ¿Ğ¾ÑĞ²Ğ»ĞµĞ½Ğ¸Ğµ â€” Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµĞ¼
            if (needSlider && window.__initSliderOnce && data.length){
                window.__initSliderOnce(minTs, maxTs);
                window.__initSliderOnce = null;
            }

            // ĞµÑĞ»Ğ¸ ÑĞ»Ğ°Ğ¹Ğ´ĞµÑ€Ğ° Ğ½ĞµÑ‚ â†’ ÑĞ±Ñ€Ğ°ÑÑ‹Ğ²Ğ°ĞµĞ¼ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸
            if (!isTrackView && needSlider){
              let dateState = null;
              if (needSlider){
                  dateState = loadDateRangeState();
                  if (dateState){
                      data = data.filter(m => m.date >= dateState[0] &&
                                              m.date <= dateState[1]);
                  }
              }
            }

            // ---- Ñ€ĞµĞ½Ğ´ĞµÑ€ Ğ¼Ğ°Ñ€ĞºĞµÑ€Ğ¾Ğ² ----------------------------
            for (const key in circleMarkers) map.removeLayer(circleMarkers[key]);
            circleMarkers = {};

            data.forEach(m=>{
                if (!shouldDisplayBySpeed(m.speed)) return;

                const cm = L.circleMarker([m.lat, m.lon], {
                    radius      : getRadius(m.doseRate, zoom),
                    fillColor   : getGradientColor(m.doseRate),
                    color       : getGradientColor(m.doseRate),
                    weight      : 1,
                    opacity     : getFillOpacity(m.speed) + 0.1,
                    fillOpacity : getFillOpacity(m.speed)
                })
                .addTo(map)
                .bindTooltip(getTooltipContent(m),
                    { direction:'top', className:'custom-tooltip', offset:[0,-8] })
                .bindPopup(getPopupContent(m));

                circleMarkers[m.id || m.trackID] = cm;
            });
        })
        .catch(err=>{
            if (err.name === 'AbortError') return;
            console.error('fetch:', err);
				})
				.finally(()=>{                                   // â¬… spinner
						if(loadingEl) loadingEl.style.display='none';  // â¬… spinner
				});
}




let debounceTimeout;

function debounceUpdateMarkers() {
	clearTimeout(debounceTimeout);
	debounceTimeout = setTimeout(updateMarkers, 300);
}

function adjustMarkerRadius() {
	var zoomLevel = map.getZoom();
	for (let key in circleMarkers) {
		let marker = circleMarkers[key];
		let newRadius = getRadius(marker.doseRate, zoomLevel);
		marker.setRadius(newRadius);
	}
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
	*  viewTrack () â€” Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´ Ğ² Ñ€ĞµĞ¶Ğ¸Ğ¼ Ğ¾Ñ‚Ğ´ĞµĞ»ÑŒĞ½Ğ¾Ğ³Ğ¾ Ñ‚Ñ€ĞµĞºĞ°.
	*  Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ğ»Ğ¸ currentTrackID = trackID ĞµÑ‰Ñ‘ Ğ”Ğ ÑĞ¼ĞµĞ½Ñ‹ window.location.
	* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
	function viewTrack(trackID) {
		currentTrackID = trackID;   // âœ¦ Ğ½Ğ¾Ğ²Ğ¾Ğµ
		isTrackView    = true;

		const bounds = map.getBounds();
		const layer  = map.hasLayer(googleSatellite) ? 'Google Satellite'
			: 'OpenStreetMap';
		const zoom   = map.getZoom();

		const trackURL =
			`/trackid/${trackID}` +
			`?minLat=${bounds.getSouthWest().lat}` +
			`&minLon=${bounds.getSouthWest().lng}` +
			`&maxLat=${bounds.getNorthEast().lat}` +
			`&maxLon=${bounds.getNorthEast().lng}` +
			`&zoom=${zoom}` +
			`&layer=${encodeURIComponent(layer)}`;

		window.location.href = trackURL;
	}


function setBaseLayer(layerName) {
	if (layerName === 'Google Satellite') {
		if (map.hasLayer(osmLayer))            map.removeLayer(osmLayer);
		if (!map.hasLayer(googleSatellite))    googleSatellite.addTo(map);
	} else {
		if (map.hasLayer(googleSatellite))     map.removeLayer(googleSatellite);
		if (!map.hasLayer(osmLayer))           osmLayer.addTo(map);
	}
}

function loadMapFromUrl() {
	const params = new URLSearchParams(window.location.search);

	/* Ğ±Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğ¹ ÑĞ»Ğ¾Ğ¹ Ğ¸Ğ· URL (Ğ¸Ğ»Ğ¸ Ğ´ĞµÑ„Ğ¾Ğ»Ñ‚) */
		const layer = decodeURIComponent(params.get('layer') || defaultCfg.layer);
	setBaseLayer(layer);

	/* Ñ‡Ğ¸Ñ‚Ğ°ĞµĞ¼ Ğ¾ÑÑ‚Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹ */
		const minLat = parseFloat(params.get('minLat'));
	const minLon = parseFloat(params.get('minLon'));
	const maxLat = parseFloat(params.get('maxLat'));
	const maxLon = parseFloat(params.get('maxLon'));

	if (!isNaN(minLat) && !isNaN(minLon) && !isNaN(maxLat) && !isNaN(maxLon)) {
		map.fitBounds([[minLat, minLon], [maxLat, maxLon]]);
		adjustMarkerRadius();
	} else if (isTrackView && trackBounds) {
		map.fitBounds(trackBounds);
	} else {
		map.setView([defaultCfg.lat, defaultCfg.lon], defaultCfg.zoom);
	}
}

function updateUrl() {
	var bounds = map.getBounds();
	var layer = map.hasLayer(googleSatellite) ? 'Google Satellite' : 'OpenStreetMap';
	var minLat = bounds.getSouthWest().lat.toFixed(5);
	var minLon = bounds.getSouthWest().lng.toFixed(5);
	var maxLat = bounds.getNorthEast().lat.toFixed(5);
	var maxLon = bounds.getNorthEast().lng.toFixed(5);
	var zoom = map.getZoom();

	var newUrl = `${window.location.pathname}?minLat=${minLat}&minLon=${minLon}&maxLat=${maxLat}&maxLon=${maxLon}&zoom=${zoom}&layer=${encodeURIComponent(layer)}`;

	window.history.replaceState({}, '', newUrl);
}

function initializeUIElements() {
	var locateButton = document.getElementById('locateButton');
	if (locateButton) {
		locateButton.addEventListener('click', centerMapToLocation);
	}

	var backToAllButton = document.getElementById('backToAllButton');
	if (backToAllButton) {
		backToAllButton.addEventListener('click', function() {
			var params = getCurrentUrlParams();
			window.location.href = '/' + params;
		});
	}
}

function centerMapToLocation() {
	if (navigator.geolocation) {
		navigator.geolocation.getCurrentPosition(
			function(position) {
				var userLat = position.coords.latitude;
				var userLon = position.coords.longitude;

				map.setView([userLat, userLon], 15);

				L.marker([userLat, userLon]).addTo(map)
					.bindPopup(translate("your_location")).openPopup();
			},
			function(error) {
				switch(error.code) {
					case error.PERMISSION_DENIED:
						alert(translate("location_permission_denied"));
						break;
					case error.POSITION_UNAVAILABLE:
						alert(translate("location_unavailable"));
						break;
					case error.TIMEOUT:
						alert(translate("location_timeout"));
						break;
					default:
						alert(translate("location_error"));
						break;
				}
			}
		);
	} else {
		alert(translate("geolocation_not_supported"));
	}
}
		</script>

		<!-- Ğ¡ĞºÑ€Ğ¸Ğ¿Ñ‚ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ² -->
		<script>
			function uploadFiles() {
				const fileInput  = document.getElementById('fileInput');
				const files      = fileInput.files;
				if (!files.length) {
					alert(translate('select_files'));
					return;
				}

				const fileOverlay          = document.getElementById('fileOverlay');
				const fileProgressContainer = document.getElementById('fileProgressContainer');
				fileProgressContainer.innerHTML = '';
				fileOverlay.style.display  = 'flex';

				/* ÑÑ‡Ñ‘Ñ‚Ñ‡Ğ¸Ğº Ğ¸ ÑÑÑ‹Ğ»ĞºĞ° Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½ĞµĞ³Ğ¾ Ñ‚Ñ€ĞµĞºĞ° */
				let completedUploads = 0;
				const totalFiles     = files.length;
				let lastTrackURL     = null;

				/* ÑĞ¾Ğ·Ğ´Ğ°Ñ‘Ğ¼ XHR Ğ´Ğ»Ñ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ³Ğ¾ Ñ„Ğ°Ğ¹Ğ»Ğ°, Ğ½Ğ¾ redirect Ğ´ĞµĞ»Ğ°ĞµĞ¼ ĞĞ”Ğ˜Ğ Ñ€Ğ°Ğ· */
				[...files].forEach(file => {
					/* --- Ğ²Ğ¸Ğ·ÑƒĞ°Ğ»ÑŒĞ½Ñ‹Ğµ ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚Ñ‹ Ğ¿Ñ€Ğ¾Ğ³Ñ€ĞµÑÑĞ° (ĞºĞ°Ğº Ğ±Ñ‹Ğ»Ğ¾) --- */
					const fileBlock        = document.createElement('div');
					fileBlock.className    = 'file-progress';
					const fileName         = document.createElement('div');
					fileName.className     = 'file-name';
					fileName.innerText     = file.name;
					const progressBar      = document.createElement('div');
					progressBar.className  = 'progress-bar';
					const progressBarInner = document.createElement('div');
					progressBarInner.className = 'progress-bar-inner';
					progressBar.appendChild(progressBarInner);
					const serverProcessing = document.createElement('div');
					serverProcessing.className = 'server-processing';
					serverProcessing.innerText = translate('waiting_for_server');
					fileBlock.append(fileName, progressBar, serverProcessing);
					fileProgressContainer.appendChild(fileBlock);
					/* ------------------------------------------------- */

					const xhr = new XMLHttpRequest();
					xhr.open('POST', '/upload', true);

					/* Ğ¿Ñ€Ğ¾Ğ³Ñ€ĞµÑÑ Ğ·Ğ°Ğ»Ğ¸Ğ²ĞºĞ¸ Ñ„Ğ°Ğ¹Ğ»Ğ° */
					xhr.upload.onprogress = e => {
						if (e.lengthComputable) {
							const percent = (e.loaded / e.total) * 100;
							progressBarInner.style.width = percent + '%';
						}
					};

					/* Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ° ÑĞµÑ€Ğ²ĞµÑ€Ğ° */
					xhr.onload = () => {
						if (xhr.status === 200) {
							const response = JSON.parse(xhr.responseText);
							if (response.status === 'success') {
								lastTrackURL             = response.trackURL;   // Ğ·Ğ°Ğ¿Ğ¾Ğ¼Ğ¸Ğ½Ğ°ĞµĞ¼
								serverProcessing.innerText = translate('processing_complete');
								serverProcessing.style.color = 'green';
							} else {
								serverProcessing.innerText = translate('error_processing_files');
								serverProcessing.style.color = 'red';
							}
						} else {
							serverProcessing.innerText = translate('error_during_upload');
							serverProcessing.style.color = 'red';
						}

						/* ÑƒĞ²ĞµĞ»Ğ¸Ñ‡Ğ¸Ğ²Ğ°ĞµĞ¼ ÑÑ‡Ñ‘Ñ‚Ñ‡Ğ¸Ğº Ğ¸, ĞµÑĞ»Ğ¸ Ğ²ÑÑ‘ Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ¾, Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ¸Ğ¼ */
						completedUploads++;
						if (completedUploads === totalFiles) {
							setTimeout(() => {
								fileOverlay.style.display = 'none';
								/* Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ¸Ğ¼ĞµĞ½Ğ½Ğ¾ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğ¹ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ñ‚Ñ€ĞµĞº */
								if (lastTrackURL) {
									window.location.href = lastTrackURL;
								} else {
									location.reload();   // Ğ½Ğ° ÑĞ»ÑƒÑ‡Ğ°Ğ¹, ĞµÑĞ»Ğ¸ Ğ²ÑĞµ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ ÑƒĞ¿Ğ°Ğ»Ğ¸
								}
							}, 700);
						}
					};

					/* Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ñ„Ğ°Ğ¹Ğ» */
					const formData = new FormData();
					formData.append('files[]', file);
					xhr.send(formData);
				});
			}
		</script>

	</body>
</html>

