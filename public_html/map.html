<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Isotope Pathways — следопыт невидимых дорог.</title>
    <link rel="stylesheet" href="/static/leaflet.css" />
    <style>
      body, html {
        margin: 0;
        padding: 0;
        height: 100%;
        overflow: hidden;
      }

      #map {
        height: 100vh;
        margin: 0;
        overflow: hidden;
      }

      .custom-tooltip {
        background-color: white;
        border-radius: 5px;
        padding: 10px;
        color: #333;
        box-shadow: 0px 0px 3px rgba(0,0,0,0.3);
      }

      .upload-btn-container {
        position: absolute;
        top: 20px;
        right: 20px;
        z-index: 1000;
      }

      .leaflet-control-container .leaflet-top.leaflet-right .upload-btn-container {
        margin-top: 40px;
      }

      .upload-btn {
        background-color: white;
        border: 1px solid #ccc;
        border-radius: 4px;
        padding: 5px 10px;
        cursor: pointer;
        font-size: 14px;
        box-shadow: 0 1px 5px rgba(0,0,0,0.65);
      }

      .upload-btn:hover {
        background-color: #f4f4f4;
      }

      .github-link {
        position: absolute;
        bottom: 20px;
        left: 20px;
        z-index: 1000;
      }

      .github-icon {
        width: 40px;
        height: 40px;
        opacity: 0.6;
      }

      .github-icon:hover {
        opacity: 1;
      }

.program-info {
  position: absolute;
  bottom: 20px;
  left: 70px; /* Отступ от иконки GitHub */
  z-index: 1000;
  color: #333;
  font-size: 14px;
  opacity: 0.6;
}

.program-info a {
  color: #007bff;
  text-decoration: none;
}

.program-info a:hover {
  text-decoration: underline;
}

.program-info:hover {
  opacity: 1;
}

    </style>
  </head>
  <body>
    <div class="upload-btn-container leaflet-control">
      <label for="fileInput" class="upload-btn">Upload [+]</label>
      <input type="file" id="fileInput" style="display: none;" multiple onchange="uploadFiles()">
    </div>

    <a href="https://github.com/matveynator/isotope-pathways" class="github-link" target="_blank">
    <img src="/static/GitHub-Mark.png" alt="GitHub" class="github-icon">
    </a>

    <div class="program-info">
    <strong>Isotope Pathways</strong><br>
	Version: <a href="https://files.zabiyaka.net/isotope-pathways/{{ .Version }}/no-gui" target="_blank">{{ .Version }}</a>
    </div>

    <div id="map"></div>

    <script src="/static/leaflet.js"></script>
    <script>
      var markers = JSON.parse('{{ .Markers | toJSON }}');
      if (!Array.isArray(markers) || markers.length === 0) {
        markers = [];
      }

      var map = L.map('map');
      var bounds = markers.map(marker => [marker.lat, marker.lon]);

      if (bounds.length > 0) {
        map.fitBounds(bounds);
      } else {
        map.setView([44.08832, 42.97577], 11);
      }

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 18,
      }).addTo(map);

      var circleMarkers = {};

      map.on('zoomend', updateMarkers);
      map.on('moveend', updateMarkers);

      function updateMarkers() {
        var zoomLevel = map.getZoom();
        var bounds = map.getBounds();

        for (let key in circleMarkers) {
          map.removeLayer(circleMarkers[key]);
        }

        circleMarkers = {};
        var filteredMarkers = filterMarkersByZoom(zoomLevel);

        filteredMarkers.forEach(function(marker) {
          var markerKey = `${marker.lat}-${marker.lon}`;

          if (bounds.contains([marker.lat, marker.lon])) {
            var color = getGradientColor(marker.doseRate, marker.countRate);
            var radius = getRadius(marker.doseRate, zoomLevel);

            var circleMarker = L.circleMarker([marker.lat, marker.lon], {
              radius: radius,
              fillColor: color,
              color: color,
              weight: 1,
              opacity: 0.7,
              fillOpacity: 0.5
            }).addTo(map)
              .bindTooltip(getTooltipContent(marker), { direction: 'top', className: 'custom-tooltip', offset: [0, -8], permanent: false });

            circleMarkers[markerKey] = circleMarker;
          }
        });

        // Обновляем URL после обновления маркеров
        updateUrl();
      }

      function getTooltipContent(marker) {
        var doseRateInMicroSieverts = marker.doseRate;
        var doseRateInMicroRoentgens = doseRateInMicroSieverts * 100;

        var date = new Date(marker.date * 1000);
        var formattedDate = date.toLocaleString();

        return `
          <div class="custom-tooltip">
            <strong>Доза радиации:</strong><br>
            ${doseRateInMicroRoentgens.toFixed(2)} µR/h (${doseRateInMicroSieverts.toFixed(2)} µSv/h)<br>
            <strong>Дата и время:</strong><br>
            ${formattedDate}
          </div>
        `;
      }

      function filterMarkersByZoom(zoomLevel) {
        if (zoomLevel > 20) {
          return markers;
        } else if (zoomLevel == 18) {
          return markers;
        } else if (zoomLevel == 17) {
          return markers;
        } else if (zoomLevel == 16) {
          return markers;
        } else if (zoomLevel == 15) {
          return markers;
        } else if (zoomLevel == 14) {
          return markers;
        } else if (zoomLevel == 13) {
          return markers.filter((_, index) => index % 5 === 0);
        } else if (zoomLevel == 12) {
          return markers.filter((_, index) => index % 10 === 0);
        } else if (zoomLevel == 11) {
          return markers.filter((_, index) => index % 15 === 0);
        } else if (zoomLevel == 10) {
          return markers.filter((_, index) => index % 20 === 0);
        } else if (zoomLevel == 9) {
          return markers.filter((_, index) => index % 25 === 0);
        } else if (zoomLevel == 8) {
          return markers.filter((_, index) => index % 30 === 0);
        } else if (zoomLevel == 7) {
          return markers.filter((_, index) => index % 35 === 0);
        } else if (zoomLevel == 6) {
          return markers.filter((_, index) => index % 40 === 0);
        } else if (zoomLevel == 5) {
          return markers.filter((_, index) => index % 45 === 0);
        } else if (zoomLevel == 4) {
          return markers.filter((_, index) => index % 50 === 0);
        } else {
          return markers.filter((_, index) => index % 55 === 0);
        }
      }

      function getRadius(doseRate, zoomLevel) {
        let baseRadius;
        if (zoomLevel > 18) baseRadius = 9;
        else if (zoomLevel == 18) baseRadius = 9;
        else if (zoomLevel == 17) baseRadius = 8;
        else if (zoomLevel == 16) baseRadius = 7;
        else if (zoomLevel == 15) baseRadius = 6;
        else if (zoomLevel == 14) baseRadius = 5;
        else if (zoomLevel == 13) baseRadius = 4;
        else if (zoomLevel == 12) baseRadius = 3;
        else if (zoomLevel == 11) baseRadius = 2;
        else baseRadius = 1;

        return baseRadius;
      }

      function getGradientColor(doseRate, countRate) {
        let colorRate = countRate === 0.0 ? (doseRate * 100) : countRate;
        if (colorRate <= 4) return "#006400";
        else if (colorRate <= 8) return interpolateColor([0, 100, 0], [173, 255, 47], (colorRate - 4) / (8 - 4));
        else if (colorRate <= 11) return interpolateColor([173, 255, 47], [255, 255, 0], (colorRate - 8) / (11 - 8));
        else if (colorRate <= 20) return interpolateColor([255, 255, 0], [255, 165, 0], (colorRate - 11) / (20 - 11));
        else if (colorRate <= 30) return interpolateColor([255, 165, 0], [255, 0, 0], (colorRate - 20) / (30 - 20));
        else if (colorRate <= 99) return interpolateColor([255, 0, 0], [0, 0, 0], (colorRate - 30) / (99 - 30));
        else return "#000000";
      }

      function interpolateColor(color1, color2, factor) {
        if (factor < 0) factor = 0;
        if (factor > 1) factor = 1;

        const r = Math.round(color1[0] + (color2[0] - color1[0]) * factor);
        const g = Math.round(color1[1] + (color2[1] - color1[1]) * factor);
        const b = Math.round(color1[2] + (color2[2] - color1[2]) * factor);

        return `rgb(${r}, ${g}, ${b})`;
      }

      // Функция для обновления URL при изменении вида карты
      function updateUrl() {
        var center = map.getCenter();
        var zoom = map.getZoom();

        var newUrl = `${window.location.pathname}?lat=${center.lat.toFixed(5)}&lon=${center.lng.toFixed(5)}&zoom=${zoom}`;

        window.history.replaceState(null, '', newUrl);
      }

      // Функция для чтения параметров из URL при загрузке страницы
      function loadMapFromUrl() {
        var params = new URLSearchParams(window.location.search);
        var lat = parseFloat(params.get('lat'));
        var lon = parseFloat(params.get('lon'));
        var zoom = parseInt(params.get('zoom'));

        if (!isNaN(lat) && !isNaN(lon) && !isNaN(zoom)) {
          map.setView([lat, lon], zoom);
        } else {
          map.setView([44.0, 43.0], 7);
        }
      }

      // Вызываем функцию для установки карты по URL
      loadMapFromUrl();

      // Вызываем функцию обновления маркеров сразу после загрузки карты
      updateMarkers();

      // Функция для загрузки файлов
      function uploadFiles() {
        var fileInput = document.getElementById('fileInput');
        var files = fileInput.files;

        if (files.length > 0) {
          var formData = new FormData();

          for (var i = 0; i < files.length; i++) {
            formData.append("files[]", files[i]);
          }

          fetch('/upload', {
            method: 'POST',
            body: formData
          })
          .then(response => response.json())
          .then(data => {
            console.log("Файлы загружены:", data);
            location.reload();
          })
          .catch(error => console.error("Ошибка:", error));
        } else {
          alert("Пожалуйста, выберите хотя бы один файл");
        }
      }
    </script>
  </body>
</html>

