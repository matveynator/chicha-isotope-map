name: stable release

on:
  push:
    branches: [ main ]

permissions:
  contents: write

# ---------- PORTABLE: всё без CGO и без DuckDB ----------
jobs:
  build_portable:
    if: contains(toJson(github.event.head_commit.message), 'stable release')
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux
          - { goos: linux,  goarch: amd64, goversion: "1.23", runner: "ubuntu-24.04" }
          - { goos: linux,  goarch: arm64, goversion: "1.23", runner: "ubuntu-24.04" }
          - { goos: linux,  goarch: 386,   goversion: "1.23", runner: "ubuntu-24.04" }
          # macOS
          - { goos: darwin, goarch: amd64, goversion: "1.23", runner: "macos-13" }
          - { goos: darwin, goarch: arm64, goversion: "1.23", runner: "macos-14" }
          # *BSD
          - { goos: freebsd, goarch: amd64, goversion: "1.23", runner: "ubuntu-24.04" }
          - { goos: openbsd, goarch: amd64, goversion: "1.23", runner: "ubuntu-24.04" }
          - { goos: netbsd,  goarch: amd64, goversion: "1.23", runner: "ubuntu-24.04" }
          # Windows
          - { goos: windows, goarch: amd64, goversion: "1.23", runner: "windows-latest" }
          - { goos: windows, goarch: arm64, goversion: "1.23", runner: "windows-latest" }

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "${{ matrix.goversion }}"
          cache: true
          cache-dependency-path: go.sum

      - name: go mod tidy (POSIX)
        if: runner.os != 'Windows'
        shell: bash
        run: go mod tidy

      - name: go mod tidy (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: go mod tidy

      - name: Build (POSIX)
        if: runner.os != 'Windows'
        shell: bash
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
        run: |
          set -euo pipefail
          export CGO_ENABLED=0
          VERSION=${{ github.run_number }}
          mkdir -p dist
          BIN="chicha-isotope-map_${GOOS}_${GOARCH}"
          GOFLAGS="-trimpath -buildvcs=false" \
          go build -tags netgo,osusergo \
                   -ldflags "-s -w -X main.CompileVersion=$VERSION" \
                   -o "dist/${BIN}"
      - name: Build (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
        run: |
          $ErrorActionPreference = "Stop"
          $env:CGO_ENABLED = "0"
          $version = "${{ github.run_number }}"
          New-Item -Force -ItemType Directory dist | Out-Null
          $bin = "chicha-isotope-map_${{ matrix.goos }}_${{ matrix.goarch }}.exe"
          go build -tags "netgo,osusergo" `
                   -ldflags "-s -w -X main.CompileVersion=$version" `
                   -o "dist/$bin"

      - name: Upload portable artifact
        uses: actions/upload-artifact@v4
        with:
          name: bin-${{ matrix.goos }}-${{ matrix.goarch }}
          path: dist/

# ---------- DUCKDB: Linux/amd64 (glibc 2.28) в контейнере + macOS (amd64/arm64) ----------
  build_duckdb:
    if: contains(toJson(github.event.head_commit.message), 'stable release')
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # macOS amd64/arm64: нативно
          - { target: darwin_amd64_duckdb, goos: darwin, goarch: amd64, goversion: "1.23", runner: "macos-13", in_container: false }
          - { target: darwin_arm64_duckdb, goos: darwin, goarch: arm64, goversion: "1.23", runner: "macos-14", in_container: false }

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # --- macOS нативно ---
      - name: Set up Go (macOS)
        if: matrix.in_container == false
        uses: actions/setup-go@v5
        with:
          go-version: "${{ matrix.goversion }}"
          cache: true
          cache-dependency-path: go.sum

      - name: go mod tidy (macOS)
        if: matrix.in_container == false
        shell: bash
        run: |
          go get github.com/marcboeker/go-duckdb/v2@latest
          go mod tidy

      - name: Build (macOS duckdb)
        if: matrix.in_container == false
        shell: bash
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
        run: |
          set -euo pipefail
          export CGO_ENABLED=1
          VERSION=${{ github.run_number }}
          mkdir -p dist
          BIN="chicha-isotope-map_${GOOS}_${GOARCH}_duckdb"
          GOFLAGS="-trimpath -buildvcs=false" \
          go build -tags "netgo,osusergo,duckdb" \
                   -ldflags "-s -w -X main.CompileVersion=$VERSION" \
                   -o "dist/${BIN}"

      - name: Upload duckdb artifact
        uses: actions/upload-artifact@v4
        with:
          name: bin-${{ matrix.target }}
          path: dist/

  build_duckdb_linux:
    if: contains(toJson(github.event.head_commit.message), 'stable release')
    runs-on: ubuntu-24.04
    container:
      # Build DuckDB binaries on Debian 11 (glibc 2.31) so the released binary works on older hosts.
      image: debian:11-slim
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install build dependencies
        shell: bash
        run: |
          set -euo pipefail
          apt-get update
          apt-get install -y --no-install-recommends \
            ca-certificates \
            curl \
            git \
            build-essential
          update-ca-certificates

      - name: Set up Go (Linux)
        uses: actions/setup-go@v5
        with:
          go-version: "1.23"
          cache: true
          cache-dependency-path: go.sum

      - name: go mod tidy (Linux)
        shell: bash
        run: |
          set -euo pipefail
          go get github.com/marcboeker/go-duckdb/v2@latest
          go mod tidy

      - name: Rebuild DuckDB static library for glibc 2.31
        shell: bash
        run: |
          set -euo pipefail
          module_dir=$(go list -f '{{.Dir}}' -m github.com/marcboeker/go-duckdb)
          # Rebuild the bundled static lib against Debian 11's toolchain to avoid
          # newer GLIBC/GLIBCXX requirements in released binaries.
          make -C "$module_dir" deps.linux.amd64

      - name: Build (Linux duckdb)
        shell: bash
        env:
          GOOS: linux
          GOARCH: amd64
        run: |
          set -euo pipefail
          export CGO_ENABLED=1
          VERSION=${{ github.run_number }}
          mkdir -p dist
          BIN="chicha-isotope-map_${GOOS}_${GOARCH}_duckdb"
          GOFLAGS="-trimpath -buildvcs=false" \
          go build -tags "netgo,osusergo,duckdb" \
                   -ldflags "-s -w -X main.CompileVersion=$VERSION" \
                   -o "dist/${BIN}"

      - name: Upload duckdb artifact (Linux)
        uses: actions/upload-artifact@v4
        with:
          name: bin-linux_amd64_duckdb
          path: dist/

  release:
    needs: [build_portable, build_duckdb, build_duckdb_linux]
    runs-on: ubuntu-24.04
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist-raw/

      - name: Publish GitHub Release (tag latest)
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: latest
          name: "download stable version"
          prerelease: false
          files: dist-raw/**/*
